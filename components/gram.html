<div class="gram{open ? ' -open' : ''}">

  <!-- Open -->
  {#if open}
    <div class="gram-chat">

      <!-- Header -->
      <div class="gram-chat-header" on:click="close()">
        <h2 class="gram-chat-header-title">{options.title}</h2>
        <p class="gram-chat-header-text">{options.name} is online.</p>
        <span class="gram-chat-header-close">Close</span>
      </div>

      <!-- History -->
      <ul class="gram-chat-history">
        {#each messages as m}
          <li class="gram-chat-entry-group">
            <p class="{'gram-chat-entry ' + (m.from_client ? '-sent' : '')}">
              {#if !m.from_client}
              <span class="gram-chat-entry-name">{options.name}</span>
              {/if}
              {m.message}
            </p>
          </li>
          <!-- TODO: group common messages so only one will have the arrow -->
          <!-- <li class="gram-chat-entry-group">
            <p class="gram-chat-entry -sent">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Iure dolor eos dolorem ipsum, deleniti officiis.</p>
          </li> -->
        {:else}
          <li class="gram-chat-empty">No messages yet</li>
        {/each}
        {#if error}
          <span class="gram-chat-message -error">
            {error}
          </span>
        {/if}
      </ul>

      <!-- Input -->
      <div class="gram-chat-input">
        <!-- TODO: Allow textarea to grow in size if user inputs stuff -->
        <textarea class="gram-chat-input-field" ref:input on:keyup="onKeyUp(event)" type="text" placeholder="Type here&hellip;"></textarea>

        {#if options.enableAttachment}
        <button type="button" class="gram-chat-input-button" on:click="attachment()">
          <svg class="gram-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
            <title>Attachment</title>
            <path d="M54.495 29.304A16 16 0 0 0 31.868 6.677L8.335 30.21a2 2 0 0 0 2.828 2.828L34.696 9.505a12 12 0 0 1 16.97 16.97l-29.189 29.19A8 8 0 1 1 11.163 44.35l26.362-26.362a4 4 0 1 1 5.657 5.658L22.475 44.352a2 2 0 0 0 2.83 2.828L46.01 26.475A8 8 0 1 0 34.697 15.16L8.335 41.522a12 12 0 0 0 16.97 16.97z" />
          </svg>
        </button>
        {/if}

        <button type="button" class="{'gram-chat-input-button -send ' + (sending ? '-sending' : '')}" on:click="triggerEnter()">
          <svg class="gram-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
            <title>Send</title>
            <path d="M4.1 28.4l21.2 8.4L55.8 5.9 4.1 28.4zm25 10.3l22.2 13.7 8.6-45-30.8 31.3z" />
            <path d="M27.3 58.1l7.8-11.2-7.8-4.8v16z" />
          </svg>
        </button>
      </div>

    </div>

  <!-- Closed -->
  {:else}
  {/if}

  <button class="gram-button" on:click="toggle()">
     <svg class="gram-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <title>Chat</title>
      <path d="M42 7H22a20 20 0 0 0 0 40h2v10l12-10h6a20 20 0 0 0 0-40zM22.1 29.1a3 3 0 1 1-4.2-4.2 3.1 3.1 0 0 1 4.2 0A3 3 0 0 1 23 27a3 3 0 0 1-.9 2.1zm12 0a3 3 0 0 1-4.2-4.2 3.1 3.1 0 0 1 4.2 0 3 3 0 0 1 0 4.3zm12 0A3 3 0 0 1 41 27a3 3 0 0 1 .9-2.1 3.1 3.1 0 0 1 4.2 0 3 3 0 0 1 0 4.2z" />
    </svg>

    <span class="gram-button-notification">1</span>
  </button>
</div>

<script>
import axios from 'axios';

export default {
  methods: {
    onKeyUp: function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        this.triggerEnter();
      }
    },
    triggerEnter: function() {
      const input = this.refs.input;
      this.send({message: input.value});
      input.value = '';
    },
    attachment: function () {
      this.set({error: "File attachments are not support yet"});
    },
    send: function(message) {
      // Pass message once through all the callbacks
      this.get().callbacks.forEach(e => e(message));
      const {user, apiKey, lastID} = this.get();
      axios({
        method: 'post',
        url: `${this.get().baseURL}/messages`,
        params: {user, apiKey},
        data: message
      })
      .then(res => {
        this.push(res.data);
        console.log(res.data);
        this.set({error: '', lastID: lastID + 1});
      })
      .catch(res => {
        this.set({error: "Couldn't send message!"});
      }).then(()=>{
        this.set({sending: false});
      });
      this.set({sending: true});
      console.log('Sending', message);
    },
    push: function(message) {
      console.log('Adding', message);
      const msgs = this.get().messages;
      const { lastID } = this.get();
      if (message.id && message.id > lastID) {
        this.set({lastID: message.id});
      }
      // Prevent double messages when polling/sending at a similar time
      if (!msgs.find(m => m.timestamp === message.timestamp)) {
        console.log('Displaying', message);
        msgs.push(message);
        this.set({messages: msgs});
      }
    },
    pull: function() {
      const e = this.get().messages;
      const {user, apiKey, lastID} = this.get();
      console.log('Pulling...');
      axios.get(`${this.get().baseURL}/messages`, {
        params: {lastID, user, apiKey}
      }).then(res => {
        res.data.forEach((d) => {
          this.push(d);
        });
        this.set({error: ''});
        console.log('Pulled');
      })
      .catch(res => {
        this.set({error: "No connection to server"});
        console.log('Setting error');
      });
    },
    poll: function(pollTime=3000) {
      clearInterval(this.get().inv);
      if (pollTime) {
        const inv = setInterval(this.pull.bind(this), pollTime);
        this.set({inv});
      }
    },

    callback: function(cb) {
      const cbs = this.get().callbacks;
      cbs.push(cb);
      this.set({callbacks: cbs});
    },
    clearCallbacks: function() {
      this.set({callbacks: []});
    },
    close: function () {
      console.log('Closing');
      this.set({open: false});
    },
    open: function () {
      console.log('Opening');
      this.set({open: true});
    },
    toggle: function() {
      console.log('Toggling');
      this.set({open: !this.get().open});
    }
  }
};
</script>
